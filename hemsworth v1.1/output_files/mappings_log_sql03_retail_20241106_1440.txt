DELTA LAKE MAPPINGS LOG - SQL03 RETAIL QUERY
Generated: November 6, 2024 2:40 PM
Source: Sportsbook Retail Performance Query (SQL03)

=== OPTIMIZATION SUMMARY ===
Applied AGENTS.md best practices for performance and readability:
✅ SARGable WHERE conditions (no functions on columns)
✅ Optimized JOIN order (smallest table first)
✅ Early filtering in JOIN conditions
✅ Replaced <> with != for consistency
✅ Used INTERVAL syntax instead of date_sub() functions
✅ Consolidated similar CASE conditions with IN clauses
✅ Removed unnecessary ROUND() functions in calculations
✅ Added comprehensive comments for maintainability
✅ Proper table aliases throughout
✅ Removed LIMIT for production use

=== TABLE MAPPINGS (CONFIRMED) ===
fdg.fact_sb_gameplay_retail -> core_views.sportsbook_retail.gameplay_legs [CONFIRMED]
service.ml.cd_fd_risk_features_union -> [CONFIRMED - Risk features]
dates_retail -> [CONFIRMED - Temporary view from SQL01, DEPENDENCY REQUIRED]

=== MISSING TABLE MAPPINGS ===
analyst_rt.br_sb_groupings -> [ANALYST_RT_BR_SB_GROUPINGS_PLACEHOLDER] [MISSING - Sport groupings lookup]

=== COLUMN MAPPINGS APPLIED ===
Original Redshift -> Delta Lake:
- bet_legs.source -> bl.source
- bet_legs.state -> bl.state
- bet_legs.business_unit_name -> bl.business_unit_name
- bet_legs.channel -> bl.channel
- bet_legs.mc_code -> bl.mc_code
- bet_legs.bet_settled_date -> bl.bet_settled_date
- bet_legs.bet_settled_date_local -> bl.bet_settled_date_local
- bet_legs.sport_name -> bl.sport_name
- bet_legs.competition_name -> bl.competition_name
- bet_legs.event_name -> bl.event_name
- bet_legs.event_start_date -> bl.event_start_date
- bet_legs.market_name -> bl.market_name
- bet_legs.handicap_value -> bl.handicap_value
- bet_legs.selection_name -> bl.selection_name
- bet_legs.event_id -> bl.event_id
- bet_legs.market_id -> bl.market_id
- bet_legs.selection_id -> bl.selection_id
- bet_legs.event_in_play -> bl.event_in_play
- bet_legs.bet_placed_date -> bl.bet_placed_date
- bet_legs.bet_type -> bl.bet_type
- bet_legs.leg_numbers -> bl.leg_numbers
- bet_legs.price_type_code -> bl.price_type_code
- bet_legs.is_same_game_parlay_plus -> bl.is_same_game_parlay_plus
- bet_legs.bet_cashed_out -> bl.bet_cashed_out
- bet_legs.leg_price_decimal -> bl.leg_price_decimal
- bet_legs.bet_percent_max_bet -> bl.bet_percent_max_bet
- bet_legs.promo_redeemed -> bl.promo_redeemed
- bet_legs.bet_stake_factor -> bl.bet_stake_factor
- bet_legs.bet_count -> bl.bet_count
- bet_legs.gross_stake -> bl.gross_stake
- bet_legs.ggr -> bl.ggr
- bet_legs.bet_status -> bl.bet_status
- bet_legs.bet_result -> bl.bet_result

=== RETAIL-SPECIFIC DIFFERENCES FROM ONLINE ===

1. **Source Table**:
   - Online: core_views.sportsbook.bet_legs
   - Retail: core_views.sportsbook_retail.gameplay_legs

2. **Business Logic Differences**:
   - **Shop Name Mapping**: Retail has complex business unit name mapping
   - **Channel**: Retail has retail_channel field
   - **Monitored Status**: Based on mc_code presence
   - **Free Bet Logic**: Uses promo_redeemed instead of leg_bonus_bet_used_amount
   - **Profit Boost**: Retail always 'Unboosted' (no profit boost feature)
   - **Liability Group**: Retail always empty (no liability categorization)

3. **Date Handling**:
   - Retail uses timezone conversion (AT TIME ZONE 'America/New_York')
   - Different date column names in some cases

4. **Revenue Calculations**:
   - Simplified expected revenue (no profit boost complexity)
   - Uses ggr for both finance_revenue and trading_revenue

=== PERFORMANCE OPTIMIZATIONS APPLIED ===

1. **SARGable Conditions**:
   - Changed: WHERE bl.bet_settled_date_local >= DATEADD(week, -2, TRUNC(SYSDATE))
   - To: WHERE bl.bet_settled_date_local >= current_date() - INTERVAL 14 DAYS

2. **JOIN Order Optimization**:
   - Start with dates_retail (smallest table from SQL01)
   - Apply main filters in JOIN condition for early filtering
   - Move partition filter to JOIN condition

3. **CASE Statement Optimization**:
   - Consolidated multiple sport name conditions using IN clauses
   - Removed redundant ILIKE functions where possible
   - Used != instead of <> for consistency

4. **Date Function Optimization**:
   - Replaced DATEADD() with INTERVAL syntax
   - Simplified timezone handling for Databricks

5. **Aggregation Optimization**:
   - Used BETWEEN for range conditions
   - Simplified complex CASE structures
   - Removed unnecessary ROUND() in intermediate calculations

=== DATABRICKS-SPECIFIC FEATURES USED ===
- GROUP BY ALL (Databricks-specific syntax)
- INTERVAL syntax for date arithmetic
- Delta Lake table references
- Proper NULL handling with NULLIF()
- CAST() instead of :: for type conversion

=== EXECUTION DEPENDENCIES ===
SQL03 requires these temporary views from SQL01:
1. dates_retail - Used for filtering retail sportsbook data (CRITICAL DEPENDENCY)
2. Available but not used: dates_online, dates_canada, months_union

=== RECOMMENDED NEXT STEPS ===
1. Create indexes on frequently filtered columns:
   - bl.bet_settled_date_local (partition column)
   - bl.bet_status
   - bl.bet_result

2. Consider partitioning strategy:
   - Partition by date (bet_settled_date_local)
   - Z-ORDER by state, business_unit_name

3. Apply OPTIMIZE command after data load:
   OPTIMIZE sandbox.shared.br_temp_sbk_performance_retail
   ZORDER BY (bet_settled_date_local, state, business_unit_name);

4. Monitor query performance with EXPLAIN ANALYZE

=== MIGRATION NOTES ===
- Query now follows all AGENTS.md best practices
- Removed LIMIT 1000 for production use
- Added comprehensive comments for analyst maintainability
- Optimized for Databricks Delta Lake performance
- **CRITICAL**: SQL03 must be executed AFTER SQL01 (depends on dates_retail view)
- Retail-specific business logic preserved and optimized
- Ready for production deployment after sport groupings table mapping is resolved

=== BUSINESS LOGIC PRESERVED ===
- Complex shop name mapping for retail locations
- Monitored status based on mc_code
- Retail channel categorization
- Promo redemption tracking
- Simplified revenue calculations (no profit boost)
- Timezone-aware date processing
